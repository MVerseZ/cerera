# Pallada Virtual Machine

Pallada ‚Äî —ç—Ç–æ –≤–∏—Ä—Ç—É–∞–ª—å–Ω–∞—è –º–∞—à–∏–Ω–∞ –¥–ª—è –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è —Å–º–∞—Ä—Ç-–∫–æ–Ω—Ç—Ä–∞–∫—Ç–æ–≤ –≤ –±–ª–æ–∫—á–µ–π–Ω–µ Cerera. VM —Å–ø—Ä–æ–µ–∫—Ç–∏—Ä–æ–≤–∞–Ω–∞ —Å –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ–º –ø—Ä–∏–Ω—Ü–∏–ø–æ–≤ —á–∏—Å—Ç–æ–≥–æ –∫–æ–¥–∞ –∏ SOLID, –æ–±–µ—Å–ø–µ—á–∏–≤–∞—è –≤—ã—Å–æ–∫—É—é –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å –∏ –Ω–∞–¥–µ–∂–Ω–æ—Å—Ç—å –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è –∫–æ–Ω—Ç—Ä–∞–∫—Ç–æ–≤.

## üìã –°–æ–¥–µ—Ä–∂–∞–Ω–∏–µ

- [–û–±–∑–æ—Ä](#–æ–±–∑–æ—Ä)
- [–ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞](#–∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞)
- [–û—Å–Ω–æ–≤–Ω—ã–µ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç—ã](#–æ—Å–Ω–æ–≤–Ω—ã–µ-–∫–æ–º–ø–æ–Ω–µ–Ω—Ç—ã)
- [–ü—Ä–∏–Ω—Ü–∏–ø—ã –ø—Ä–æ–µ–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è](#–ø—Ä–∏–Ω—Ü–∏–ø—ã-–ø—Ä–æ–µ–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è)
- [–ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ](#–∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ)
- [–ò–Ω—Å—Ç—Ä—É–∫—Ü–∏–∏ (Opcodes)](#–∏–Ω—Å—Ç—Ä—É–∫—Ü–∏–∏-opcodes)
- [–°–∏—Å—Ç–µ–º–∞ –≥–∞–∑–∞](#—Å–∏—Å—Ç–µ–º–∞-–≥–∞–∑–∞)
- [–¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ](#—Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ)
- [–ü—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å](#–ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å)

## üéØ –û–±–∑–æ—Ä

Pallada VM ‚Äî —ç—Ç–æ —Å—Ç–µ–∫–æ–≤–∞—è –≤–∏—Ä—Ç—É–∞–ª—å–Ω–∞—è –º–∞—à–∏–Ω–∞, –∞–Ω–∞–ª–æ–≥–∏—á–Ω–∞—è EVM (Ethereum Virtual Machine), –Ω–æ –æ–ø—Ç–∏–º–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω–∞—è –¥–ª—è –±–ª–æ–∫—á–µ–π–Ω–∞ Cerera. VM –≤—ã–ø–æ–ª–Ω—è–µ—Ç –±–∞–π—Ç–∫–æ–¥ –∫–æ–Ω—Ç—Ä–∞–∫—Ç–æ–≤, —É–ø—Ä–∞–≤–ª—è–µ—Ç —Å–æ—Å—Ç–æ—è–Ω–∏–µ–º, –ø–∞–º—è—Ç—å—é –∏ –≥–∞–∑–æ–º.

### –û—Å–Ω–æ–≤–Ω—ã–µ –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç–∏

- ‚úÖ **–°—Ç–µ–∫–æ–≤–∞—è –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞** ‚Äî –æ–ø–µ—Ä–∞–Ω–¥—ã —Ö—Ä–∞–Ω—è—Ç—Å—è –≤ —Å—Ç–µ–∫–µ (256-–±–∏—Ç–Ω—ã–µ —á–∏—Å–ª–∞)
- ‚úÖ **–õ–∏–Ω–µ–π–Ω–∞—è –ø–∞–º—è—Ç—å** ‚Äî –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–∏ —Ä–∞—Å—à–∏—Ä—è–µ–º–∞—è –ø–∞–º—è—Ç—å –¥–ª—è –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è
- ‚úÖ **Persistent Storage** ‚Äî –ø–æ—Å—Ç–æ—è–Ω–Ω–æ–µ —Ö—Ä–∞–Ω–∏–ª–∏—â–µ –¥–ª—è –¥–∞–Ω–Ω—ã—Ö –∫–æ–Ω—Ç—Ä–∞–∫—Ç–∞
- ‚úÖ **–°–∏—Å—Ç–µ–º–∞ –≥–∞–∑–∞** ‚Äî –∫–æ–Ω—Ç—Ä–æ–ª—å –ø–æ—Ç—Ä–µ–±–ª–µ–Ω–∏—è —Ä–µ—Å—É—Ä—Å–æ–≤
- ‚úÖ **–ú–µ–∂–∫–æ–Ω—Ç—Ä–∞–∫—Ç–Ω—ã–µ –≤—ã–∑–æ–≤—ã** ‚Äî –ø–æ–¥–¥–µ—Ä–∂–∫–∞ –≤—ã–∑–æ–≤–æ–≤ –º–µ–∂–¥—É –∫–æ–Ω—Ç—Ä–∞–∫—Ç–∞–º–∏
- ‚úÖ **–û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫** ‚Äî RETURN –∏ REVERT –¥–ª—è —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –≤—ã–ø–æ–ª–Ω–µ–Ω–∏–µ–º

## üèóÔ∏è –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞

```
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ              VM (Virtual Machine)       ‚îÇ
‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§
‚îÇ  ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê  ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê  ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê ‚îÇ
‚îÇ  ‚îÇ  Stack   ‚îÇ  ‚îÇ  Memory  ‚îÇ  ‚îÇ  PC   ‚îÇ ‚îÇ
‚îÇ  ‚îÇ (1024)   ‚îÇ  ‚îÇ  (1 MB)  ‚îÇ  ‚îÇ       ‚îÇ ‚îÇ
‚îÇ  ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò  ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò  ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò ‚îÇ
‚îÇ  ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê  ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê           ‚îÇ
‚îÇ  ‚îÇGasMeter  ‚îÇ  ‚îÇ Context  ‚îÇ           ‚îÇ
‚îÇ  ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò  ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò           ‚îÇ
‚îÇ  ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê  ‚îÇ
‚îÇ  ‚îÇ      Opcode Dispatcher           ‚îÇ  ‚îÇ
‚îÇ  ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò  ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
         ‚îÇ              ‚îÇ
         ‚ñº              ‚ñº
    Storage        Call Interface
```

## üîß –û—Å–Ω–æ–≤–Ω—ã–µ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç—ã

### 1. Stack (–°—Ç–µ–∫ –æ–ø–µ—Ä–∞–Ω–¥–æ–≤)

–°—Ç–µ–∫ –¥–ª—è —Ö—Ä–∞–Ω–µ–Ω–∏—è 256-–±–∏—Ç–Ω—ã—Ö –∑–Ω–∞—á–µ–Ω–∏–π (`*big.Int`). –ú–∞–∫—Å–∏–º–∞–ª—å–Ω–∞—è –≥–ª—É–±–∏–Ω–∞ ‚Äî 1024 —ç–ª–µ–º–µ–Ω—Ç–∞.

**–û–ø–µ—Ä–∞—Ü–∏–∏:**
- `Push(value *big.Int)` ‚Äî –¥–æ–±–∞–≤–∏—Ç—å –∑–Ω–∞—á–µ–Ω–∏–µ –Ω–∞ —Å—Ç–µ–∫
- `Pop() (*big.Int, error)` ‚Äî –∏–∑–≤–ª–µ—á—å –∑–Ω–∞—á–µ–Ω–∏–µ —Å–æ —Å—Ç–µ–∫–∞
- `PeekAt(depth int) (*big.Int, error)` ‚Äî –ø–æ—Å–º–æ—Ç—Ä–µ—Ç—å –∑–Ω–∞—á–µ–Ω–∏–µ –Ω–∞ –≥–ª—É–±–∏–Ω–µ
- `Swap(n int)` ‚Äî –æ–±–º–µ–Ω—è—Ç—å —ç–ª–µ–º–µ–Ω—Ç—ã
- `Dup(n int)` ‚Äî –¥—É–±–ª–∏—Ä–æ–≤–∞—Ç—å —ç–ª–µ–º–µ–Ω—Ç

**–û–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è:** –ü–µ—Ä–µ–∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ —ç–ª–µ–º–µ–Ω—Ç–æ–≤ —Å–ª–∞–π—Å–∞ –¥–ª—è —Å–Ω–∏–∂–µ–Ω–∏—è –∞–ª–ª–æ–∫–∞—Ü–∏–π –ø–∞–º—è—Ç–∏.

### 2. Memory (–ü–∞–º—è—Ç—å –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è)

–õ–∏–Ω–µ–π–Ω–∞—è –±–∞–π—Ç-–∞–¥—Ä–µ—Å—É–µ–º–∞—è –ø–∞–º—è—Ç—å, —Ä–∞—Å—à–∏—Ä—è–µ–º–∞—è –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–∏ –¥–æ 1 MB.

**–û–ø–µ—Ä–∞—Ü–∏–∏:**
- `Store(offset *big.Int, value *big.Int)` ‚Äî —Å–æ—Ö—Ä–∞–Ω–∏—Ç—å 32-–±–∞–π—Ç–Ω–æ–µ —Å–ª–æ–≤–æ
- `Load(offset *big.Int) (*big.Int, error)` ‚Äî –∑–∞–≥—Ä—É–∑–∏—Ç—å 32-–±–∞–π—Ç–Ω–æ–µ —Å–ª–æ–≤–æ
- `StoreByte(offset *big.Int, value byte)` ‚Äî —Å–æ—Ö—Ä–∞–Ω–∏—Ç—å –±–∞–π—Ç
- `Copy(offset, length *big.Int) ([]byte, error)` ‚Äî –∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å –¥–∞–Ω–Ω—ã–µ
- `Set(offset *big.Int, data []byte)` ‚Äî —É—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –¥–∞–Ω–Ω—ã–µ

**–û–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è:** –ù–∞—á–∞–ª—å–Ω–∞—è –µ–º–∫–æ—Å—Ç—å 1KB –¥–ª—è —Å–Ω–∏–∂–µ–Ω–∏—è –ø–µ—Ä–µ–∞–ª–ª–æ–∫–∞—Ü–∏–π.

### 3. GasMeter (–°—á–µ—Ç—á–∏–∫ –≥–∞–∑–∞)

–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –ø–æ—Ç—Ä–µ–±–ª–µ–Ω–∏–µ–º –≥–∞–∑–∞ –≤–æ –≤—Ä–µ–º—è –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è.

**–ú–µ—Ç–æ–¥—ã:**
- `ConsumeGas(amount uint64, reason string) error` ‚Äî –ø–æ—Ç—Ä–µ–±–ª—è—Ç—å –≥–∞–∑
- `GasRemaining() uint64` ‚Äî –æ—Å—Ç–∞–≤—à–∏–π—Å—è –≥–∞–∑
- `GasUsed() uint64` ‚Äî –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–Ω—ã–π –≥–∞–∑
- `GasLimit() uint64` ‚Äî –ª–∏–º–∏—Ç –≥–∞–∑–∞

### 4. Context (–ö–æ–Ω—Ç–µ–∫—Å—Ç –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è)

–°–æ–¥–µ—Ä–∂–∏—Ç –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ–± –æ–∫—Ä—É–∂–µ–Ω–∏–∏ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è –∫–æ–Ω—Ç—Ä–∞–∫—Ç–∞:

```go
type Context struct {
    Caller    types.Address    // –ê–¥—Ä–µ—Å –≤—ã–∑—ã–≤–∞—é—â–µ–≥–æ
    Address   types.Address    // –ê–¥—Ä–µ—Å –∫–æ–Ω—Ç—Ä–∞–∫—Ç–∞
    Value     *big.Int         // –ü–µ—Ä–µ–¥–∞–Ω–Ω–æ–µ –∑–Ω–∞—á–µ–Ω–∏–µ
    Input     []byte           // –í—Ö–æ–¥–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ
    GasLimit  uint64           // –õ–∏–º–∏—Ç –≥–∞–∑–∞
    GasPrice  *big.Int         // –¶–µ–Ω–∞ –≥–∞–∑–∞
    BlockInfo *BlockInfo       // –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –±–ª–æ–∫–µ
    Storage   StorageInterface // –ò–Ω—Ç–µ—Ä—Ñ–µ–π—Å storage
    Call      CallInterface    // –ò–Ω—Ç–µ—Ä—Ñ–µ–π—Å –≤—ã–∑–æ–≤–æ–≤
}
```

### 5. VM (–í–∏—Ä—Ç—É–∞–ª—å–Ω–∞—è –º–∞—à–∏–Ω–∞)

–û—Å–Ω–æ–≤–Ω–æ–π –∫–æ–º–ø–æ–Ω–µ–Ω—Ç, —É–ø—Ä–∞–≤–ª—è—é—â–∏–π –≤—ã–ø–æ–ª–Ω–µ–Ω–∏–µ–º –±–∞–π—Ç–∫–æ–¥–∞.

**–ú–µ—Ç–æ–¥—ã:**
- `NewVM(code []byte, ctx *Context) *VM` ‚Äî —Å–æ–∑–¥–∞—Ç—å VM
- `Run() ([]byte, error)` ‚Äî –≤—ã–ø–æ–ª–Ω–∏—Ç—å –±–∞–π—Ç–∫–æ–¥
- `GasUsed() uint64` ‚Äî –ø–æ–ª—É—á–∏—Ç—å –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–Ω—ã–π –≥–∞–∑

## üé® –ü—Ä–∏–Ω—Ü–∏–ø—ã –ø—Ä–æ–µ–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è

### SOLID Principles

1. **Single Responsibility Principle (SRP)**
   - `Stack` ‚Äî —Ç–æ–ª—å–∫–æ —É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Å—Ç–µ–∫–æ–º
   - `Memory` ‚Äî —Ç–æ–ª—å–∫–æ —É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –ø–∞–º—è—Ç—å—é
   - `GasMeter` ‚Äî —Ç–æ–ª—å–∫–æ —É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –≥–∞–∑–æ–º
   - `VM` ‚Äî —Ç–æ–ª—å–∫–æ —É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏–µ–º

2. **Interface Segregation Principle (ISP)**
   - `StorageInterface` ‚Äî –æ—Ç–¥–µ–ª—å–Ω—ã–π –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å –¥–ª—è storage
   - `CallInterface` ‚Äî –æ—Ç–¥–µ–ª—å–Ω—ã–π –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å –¥–ª—è –≤—ã–∑–æ–≤–æ–≤
   - `GasMeter` ‚Äî –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å –¥–ª—è —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –≥–∞–∑–æ–º

3. **Dependency Inversion Principle (DIP)**
   - –ó–∞–≤–∏—Å–∏–º–æ—Å—Ç—å –æ—Ç –∞–±—Å—Ç—Ä–∞–∫—Ü–∏–π (`StorageInterface`, `CallInterface`, `GasMeter`)
   - –õ–µ–≥–∫–∞—è –∑–∞–º–µ–Ω–∞ —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–π –¥–ª—è —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è

4. **Strategy Pattern**
   - –ö–∞–∂–¥—ã–π –æ–ø–∫–æ–¥ –∏–º–µ–µ—Ç —Å–≤–æ—é —Ñ—É–Ω–∫—Ü–∏—é-–æ–±—Ä–∞–±–æ—Ç—á–∏–∫
   - –õ–µ–≥–∫–æ–µ –¥–æ–±–∞–≤–ª–µ–Ω–∏–µ –Ω–æ–≤—ã—Ö –æ–ø–∫–æ–¥–æ–≤

## üíª –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ

### –ë–∞–∑–æ–≤—ã–π –ø—Ä–∏–º–µ—Ä

```go
package main

import (
    "math/big"
    "github.com/cerera/internal/pallada"
    "github.com/cerera/internal/cerera/types"
)

func main() {
    // –ë–∞–π—Ç–∫–æ–¥: PUSH1 42, PUSH1 0, MSTORE, STOP
    code := []byte{
        0x60, 0x2a, // PUSH1 42
        0x60, 0x00, // PUSH1 0
        0x52,       // MSTORE
        0x00,       // STOP
    }

    // –°–æ–∑–¥–∞–µ–º –∫–æ–Ω—Ç–µ–∫—Å—Ç
    ctx := pallada.NewContextWithStorage(
        types.Address{},  // caller
        types.Address{},  // address
        big.NewInt(0),    // value
        nil,              // input
        10000,            // gasLimit
        big.NewInt(1),    // gasPrice
        &pallada.BlockInfo{
            Number:    1,
            Timestamp: 1234567890,
            Hash:      make([]byte, 32),
        },
        newMockStorage(), // storage
    )

    // –°–æ–∑–¥–∞–µ–º –∏ –∑–∞–ø—É—Å–∫–∞–µ–º VM
    vm := pallada.NewVM(code, ctx)
    result, err := vm.Run()
    
    if err != nil {
        panic(err)
    }
    
    // –ü—Ä–æ–≤–µ—Ä—è–µ–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç
    gasUsed := vm.GasUsed()
    fmt.Printf("Gas used: %d\n", gasUsed)
}
```

### –ê—Ä–∏—Ñ–º–µ—Ç–∏—á–µ—Å–∫–∏–µ –æ–ø–µ—Ä–∞—Ü–∏–∏

```go
// –ë–∞–π—Ç–∫–æ–¥: PUSH1 10, PUSH1 5, ADD, STOP
// –í—ã—á–∏—Å–ª—è–µ—Ç 10 + 5 = 15
code := []byte{
    0x60, 0x0a, // PUSH1 10
    0x60, 0x05, // PUSH1 5
    0x01,       // ADD
    0x00,       // STOP
}
```

### –†–∞–±–æ—Ç–∞ —Å storage

```go
// –ë–∞–π—Ç–∫–æ–¥: PUSH1 100, PUSH1 0, SSTORE, STOP
// –°–æ—Ö—Ä–∞–Ω—è–µ—Ç 100 –≤ storage –ø–æ –∫–ª—é—á—É 0
code := []byte{
    0x60, 0x64, // PUSH1 100
    0x60, 0x00, // PUSH1 0
    0x55,       // SSTORE
    0x00,       // STOP
}
```

### RETURN –¥–∞–Ω–Ω—ã—Ö

```go
// –ë–∞–π—Ç–∫–æ–¥: PUSH1 4, PUSH1 0, MSTORE, PUSH1 4, PUSH1 0, RETURN
// –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç 4 –±–∞–π—Ç–∞ –∏–∑ –ø–∞–º—è—Ç–∏
code := []byte{
    0x60, 0x04, // PUSH1 4 (length)
    0x60, 0x00, // PUSH1 0 (offset)
    0x52,       // MSTORE
    0x60, 0x04, // PUSH1 4 (length)
    0x60, 0x00, // PUSH1 0 (offset)
    0xF3,       // RETURN
}
```

## üìö –ò–Ω—Å—Ç—Ä—É–∫—Ü–∏–∏ (Opcodes)

### –ê—Ä–∏—Ñ–º–µ—Ç–∏—á–µ—Å–∫–∏–µ –æ–ø–µ—Ä–∞—Ü–∏–∏ (0x01-0x0B)

| Opcode | Hex | –û–ø–∏—Å–∞–Ω–∏–µ | –ì–∞–∑ |
|--------|-----|----------|-----|
| ADD    | 0x01 | –°–ª–æ–∂–µ–Ω–∏–µ (a + b) | 3 |
| MUL    | 0x02 | –£–º–Ω–æ–∂–µ–Ω–∏–µ (a * b) | 5 |
| SUB    | 0x03 | –í—ã—á–∏—Ç–∞–Ω–∏–µ (a - b) | 3 |
| DIV    | 0x04 | –î–µ–ª–µ–Ω–∏–µ (a / b) | 5 |
| SDIV   | 0x05 | –ó–Ω–∞–∫–æ–≤–æ–µ –¥–µ–ª–µ–Ω–∏–µ | 5 |
| MOD    | 0x06 | –û—Å—Ç–∞—Ç–æ–∫ (a % b) | 5 |
| SMOD   | 0x07 | –ó–Ω–∞–∫–æ–≤—ã–π –æ—Å—Ç–∞—Ç–æ–∫ | 5 |
| ADDMOD | 0x08 | (a + b) mod n | 8 |
| MULMOD | 0x09 | (a * b) mod n | 8 |
| EXP    | 0x0A | –í–æ–∑–≤–µ–¥–µ–Ω–∏–µ –≤ —Å—Ç–µ–ø–µ–Ω—å (a^b) | 8 + len(b)*4 |
| SIGNEXTEND | 0x0B | –†–∞—Å—à–∏—Ä–µ–Ω–∏–µ –∑–Ω–∞–∫–∞ | 5 |

### –û–ø–µ—Ä–∞—Ü–∏–∏ —Å—Ä–∞–≤–Ω–µ–Ω–∏—è (0x10-0x14)

| Opcode | Hex | –û–ø–∏—Å–∞–Ω–∏–µ | –ì–∞–∑ |
|--------|-----|----------|-----|
| LT     | 0x10 | –ú–µ–Ω—å—à–µ (a < b) | 3 |
| GT     | 0x11 | –ë–æ–ª—å—à–µ (a > b) | 3 |
| SLT    | 0x12 | –ó–Ω–∞–∫–æ–≤–æ–µ –º–µ–Ω—å—à–µ | 3 |
| SGT    | 0x13 | –ó–Ω–∞–∫–æ–≤–æ–µ –±–æ–ª—å—à–µ | 3 |
| EQ     | 0x14 | –†–∞–≤–Ω–æ (a == b) | 3 |

### –ü–æ–±–∏—Ç–æ–≤—ã–µ –æ–ø–µ—Ä–∞—Ü–∏–∏ (0x15-0x1D)

| Opcode | Hex | –û–ø–∏—Å–∞–Ω–∏–µ | –ì–∞–∑ |
|--------|-----|----------|-----|
| ISZERO | 0x15 | –ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞ –Ω–æ–ª—å | 3 |
| AND    | 0x16 | –ü–æ–±–∏—Ç–æ–≤–æ–µ –ò | 3 |
| OR     | 0x17 | –ü–æ–±–∏—Ç–æ–≤–æ–µ –ò–õ–ò | 3 |
| XOR    | 0x18 | –ü–æ–±–∏—Ç–æ–≤–æ–µ XOR | 3 |
| NOT    | 0x19 | –ü–æ–±–∏—Ç–æ–≤–æ–µ –ù–ï | 3 |
| BYTE   | 0x1A | –ò–∑–≤–ª–µ—á–µ–Ω–∏–µ –±–∞–π—Ç–∞ | 3 |
| SHL    | 0x1B | –°–¥–≤–∏–≥ –≤–ª–µ–≤–æ | 3 |
| SHR    | 0x1C | –°–¥–≤–∏–≥ –≤–ø—Ä–∞–≤–æ | 3 |
| SAR    | 0x1D | –ê—Ä–∏—Ñ–º–µ—Ç–∏—á–µ—Å–∫–∏–π —Å–¥–≤–∏–≥ | 3 |

### –û–ø–µ—Ä–∞—Ü–∏–∏ —Å–æ —Å—Ç–µ–∫–æ–º –∏ –ø–∞–º—è—Ç—å—é (0x50-0x7F)

| Opcode | Hex | –û–ø–∏—Å–∞–Ω–∏–µ | –ì–∞–∑ |
|--------|-----|----------|-----|
| POP    | 0x50 | –£–¥–∞–ª–∏—Ç—å —ç–ª–µ–º–µ–Ω—Ç —Å–æ —Å—Ç–µ–∫–∞ | 2 |
| MLOAD  | 0x51 | –ó–∞–≥—Ä—É–∑–∏—Ç—å –∏–∑ –ø–∞–º—è—Ç–∏ | 3 + —Ä–∞—Å—à–∏—Ä–µ–Ω–∏–µ |
| MSTORE | 0x52 | –°–æ—Ö—Ä–∞–Ω–∏—Ç—å –≤ –ø–∞–º—è—Ç—å | 3 + —Ä–∞—Å—à–∏—Ä–µ–Ω–∏–µ |
| MSTORE8 | 0x53 | –°–æ—Ö—Ä–∞–Ω–∏—Ç—å –±–∞–π—Ç –≤ –ø–∞–º—è—Ç—å | 3 + —Ä–∞—Å—à–∏—Ä–µ–Ω–∏–µ |
| SLOAD  | 0x54 | –ó–∞–≥—Ä—É–∑–∏—Ç—å –∏–∑ storage | 100 |
| SSTORE | 0x55 | –°–æ—Ö—Ä–∞–Ω–∏—Ç—å –≤ storage | 200-20000 |
| MSIZE  | 0x56 | –†–∞–∑–º–µ—Ä –ø–∞–º—è—Ç–∏ | 2 |
| PUSH1  | 0x60 | Push 1 –±–∞–π—Ç | 3 |
| ...    | ...  | ... | ... |
| PUSH32 | 0x7F | Push 32 –±–∞–π—Ç–∞ | 3 |

### –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –ø–æ—Ç–æ–∫–æ–º (0xF1-0xFD)

| Opcode | Hex | –û–ø–∏—Å–∞–Ω–∏–µ | –ì–∞–∑ |
|--------|-----|----------|-----|
| CALL   | 0xF1 | –ú–µ–∂–∫–æ–Ω—Ç—Ä–∞–∫—Ç–Ω—ã–π –≤—ã–∑–æ–≤ | 100 + value*9000 |
| RETURN | 0xF3 | –í–æ–∑–≤—Ä–∞—Ç –¥–∞–Ω–Ω—ã—Ö | 0 |
| REVERT | 0xFD | –û—Ç–∫–∞—Ç —Å –¥–∞–Ω–Ω—ã–º–∏ | 0 |
| STOP   | 0x00 | –û—Å—Ç–∞–Ω–æ–≤–∫–∞ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è | 0 |

## ‚õΩ –°–∏—Å—Ç–µ–º–∞ –≥–∞–∑–∞

### –ë–∞–∑–æ–≤—ã–µ —Å—Ç–æ–∏–º–æ—Å—Ç–∏

```go
const (
    GasZero        uint64 = 0     // –ë–µ—Å–ø–ª–∞—Ç–Ω—ã–µ –æ–ø–µ—Ä–∞—Ü–∏–∏
    GasBase        uint64 = 2     // –ë–∞–∑–æ–≤–∞—è —Å—Ç–æ–∏–º–æ—Å—Ç—å –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏–∏
    GasVeryLow     uint64 = 3     // –û—á–µ–Ω—å –¥–µ—à–µ–≤—ã–µ –æ–ø–µ—Ä–∞—Ü–∏–∏
    GasLow         uint64 = 5     // –î–µ—à–µ–≤—ã–µ –æ–ø–µ—Ä–∞—Ü–∏–∏
    GasMid         uint64 = 8     // –°—Ä–µ–¥–Ω–∏–µ –æ–ø–µ—Ä–∞—Ü–∏–∏
    GasHigh        uint64 = 10    // –î–æ—Ä–æ–≥–∏–µ –æ–ø–µ—Ä–∞—Ü–∏–∏
    GasSLoad       uint64 = 100   // –ó–∞–≥—Ä—É–∑–∫–∞ –∏–∑ storage
    GasSStore      uint64 = 200   // –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –≤ storage (–±–∞–∑–æ–≤–∞—è)
    GasSStoreSet   uint64 = 20000 // –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –Ω–æ–≤–æ–≥–æ –∑–Ω–∞—á–µ–Ω–∏—è
    GasSStoreReset uint64 = 5000  // –ò–∑–º–µ–Ω–µ–Ω–∏–µ —Å—É—â–µ—Å—Ç–≤—É—é—â–µ–≥–æ –∑–Ω–∞—á–µ–Ω–∏—è
    GasCall        uint64 = 100   // –ë–∞–∑–æ–≤—ã–π CALL
    GasCallValue   uint64 = 9000  // –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–æ –ø—Ä–∏ –ø–µ—Ä–µ–¥–∞—á–µ value
)
```

### –†–∞—Å—á–µ—Ç –≥–∞–∑–∞ –¥–ª—è –ø–∞–º—è—Ç–∏

–†–∞—Å—à–∏—Ä–µ–Ω–∏–µ –ø–∞–º—è—Ç–∏ —Ç—Ä–µ–±—É–µ—Ç –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–æ–≥–æ –≥–∞–∑–∞:
- –§–æ—Ä–º—É–ª–∞: `(expansion¬≤ / 512) + (expansion * 4)`
- –ì–¥–µ `expansion` ‚Äî –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –Ω–æ–≤—ã—Ö –±–∞–π—Ç–æ–≤

### –†–∞—Å—á–µ—Ç –≥–∞–∑–∞ –¥–ª—è SSTORE

- –ù–æ–≤–æ–µ –∑–Ω–∞—á–µ–Ω–∏–µ (0 ‚Üí non-zero): 20000
- –ò–∑–º–µ–Ω–µ–Ω–∏–µ –∑–Ω–∞—á–µ–Ω–∏—è (non-zero ‚Üí non-zero): 5000
- –£–¥–∞–ª–µ–Ω–∏–µ –∑–Ω–∞—á–µ–Ω–∏—è (non-zero ‚Üí 0): 200

## üß™ –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ

### –ó–∞–ø—É—Å–∫ —Ç–µ—Å—Ç–æ–≤

```bash
# –í—Å–µ —Ç–µ—Å—Ç—ã
go test ./internal/pallada/...

# –° –ø–æ–∫—Ä—ã—Ç–∏–µ–º
go test ./internal/pallada/... -cover

# –î–µ—Ç–∞–ª—å–Ω—ã–π –≤—ã–≤–æ–¥
go test ./internal/pallada/... -v
```

### –ü–æ–∫—Ä—ã—Ç–∏–µ –∫–æ–¥–∞

–¢–µ–∫—É—â–µ–µ –ø–æ–∫—Ä—ã—Ç–∏–µ: **61.2%**

```bash
go test ./internal/pallada/... -coverprofile=coverage.out
go tool cover -func=coverage.out
```

### –°—Ç—Ä—É–∫—Ç—É—Ä–∞ —Ç–µ—Å—Ç–æ–≤

- `stack_test.go` ‚Äî —Ç–µ—Å—Ç—ã —Å—Ç–µ–∫–∞
- `memory_test.go` ‚Äî —Ç–µ—Å—Ç—ã –ø–∞–º—è—Ç–∏
- `gas_test.go` ‚Äî —Ç–µ—Å—Ç—ã –≥–∞–∑–∞
- `opcodes_test.go` ‚Äî —Ç–µ—Å—Ç—ã –æ–ø–∫–æ–¥–æ–≤
- `vm_test.go` ‚Äî –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–æ–Ω–Ω—ã–µ —Ç–µ—Å—Ç—ã VM

### –ü—Ä–∏–º–µ—Ä —Ç–µ—Å—Ç–∞

```go
func TestVM_Arithmetic(t *testing.T) {
    // –ë–∞–π—Ç–∫–æ–¥: PUSH1 10, PUSH1 5, ADD, STOP
    code := []byte{
        0x60, 0x0a, // PUSH1 10
        0x60, 0x05, // PUSH1 5
        0x01,       // ADD
        0x00,       // STOP
    }

    ctx := NewContextWithStorage(...)
    vm := NewVM(code, ctx)
    result, err := vm.Run()

    if err != nil {
        t.Fatalf("Run failed: %v", err)
    }

    // –ü—Ä–æ–≤–µ—Ä—è–µ–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç –Ω–∞ —Å—Ç–µ–∫–µ
    top, _ := vm.stack.Peek()
    if top.Cmp(big.NewInt(15)) != 0 {
        t.Errorf("Expected 15, got %s", top.String())
    }
}
```

## ‚ö° –ü—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å

### –û–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏

1. **–ü–µ—Ä–µ–∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ –ø–∞–º—è—Ç–∏**
   - –°—Ç–µ–∫ –ø–µ—Ä–µ–∏—Å–ø–æ–ª—å–∑—É–µ—Ç —ç–ª–µ–º–µ–Ω—Ç—ã —Å–ª–∞–π—Å–∞
   - –ü–∞–º—è—Ç—å –Ω–µ –æ–±—Ä–µ–∑–∞–µ—Ç—Å—è –ø–æ—Å–ª–µ –æ—á–∏—Å—Ç–∫–∏

2. **–ù–∞—á–∞–ª—å–Ω—ã–µ –µ–º–∫–æ—Å—Ç–∏**
   - –°—Ç–µ–∫: 16 —ç–ª–µ–º–µ–Ω—Ç–æ–≤
   - –ü–∞–º—è—Ç—å: 1KB

3. **–≠—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω—ã–µ –æ–ø–µ—Ä–∞—Ü–∏–∏**
   - –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ `big.Int` –¥–ª—è 256-–±–∏—Ç–Ω—ã—Ö —á–∏—Å–µ–ª
   - –ú–∏–Ω–∏–º—É–º –∞–ª–ª–æ–∫–∞—Ü–∏–π

### –û–≥—Ä–∞–Ω–∏—á–µ–Ω–∏—è

- **–ú–∞–∫—Å–∏–º–∞–ª—å–Ω–∞—è –≥–ª—É–±–∏–Ω–∞ —Å—Ç–µ–∫–∞:** 1024 —ç–ª–µ–º–µ–Ω—Ç–∞
- **–ú–∞–∫—Å–∏–º–∞–ª—å–Ω—ã–π —Ä–∞–∑–º–µ—Ä –ø–∞–º—è—Ç–∏:** 1 MB
- **–†–∞–∑–º–µ—Ä —Å–ª–æ–≤–∞:** 32 –±–∞–π—Ç–∞ (256 –±–∏—Ç)

## üìù –õ–∏—Ü–µ–Ω–∑–∏—è

–°–º. [LICENSE](../../LICENSE) –≤ –∫–æ—Ä–Ω–µ –ø—Ä–æ–µ–∫—Ç–∞.

## ü§ù –í–∫–ª–∞–¥

–°–º. [CONTRIBUTING.md](../../CONTRIBUTING.md) –¥–ª—è —Ä—É–∫–æ–≤–æ–¥—Å—Ç–≤–∞ –ø–æ –≤–Ω–µ—Å–µ–Ω–∏—é –∏–∑–º–µ–Ω–µ–Ω–∏–π.

---

**Pallada VM** ‚Äî —á–∞—Å—Ç—å –±–ª–æ–∫—á–µ–π–Ω–∞ Cerera. –†–∞–∑—Ä–∞–±–æ—Ç–∞–Ω–æ —Å –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ–º –ø—Ä–∏–Ω—Ü–∏–ø–æ–≤ —á–∏—Å—Ç–æ–≥–æ –∫–æ–¥–∞ –∏ SOLID.
